



-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. Profiles (extends auth.users)
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  username TEXT,
  full_name TEXT,
  avatar_url TEXT,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Stores (One store per user/profile for simplicity, or one-to-many)
CREATE TABLE public.stores (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  owner_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  domain TEXT,
  slug TEXT UNIQUE, -- for subdomain routing potentially
  settings JSONB DEFAULT '{}'::JSONB, -- StoreSettings JSON structure
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Categories
CREATE TABLE public.categories (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  parent_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Brands
CREATE TABLE public.brands (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. Models
CREATE TABLE public.models (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 6. Materials
CREATE TABLE public.materials (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 7. Colors
CREATE TABLE public.colors (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  hex TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 8. Products
CREATE TABLE public.products (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  sku TEXT,
  price DECIMAL(10, 2) NOT NULL,
  stock INTEGER DEFAULT 0,
  category_id UUID REFERENCES public.categories(id),
  brand_id UUID REFERENCES public.brands(id),
  model_id UUID REFERENCES public.models(id),
  material_id UUID REFERENCES public.materials(id),
  color_id UUID REFERENCES public.colors(id),
  description TEXT,
  status TEXT CHECK (status IN ('Ativo', 'Inativo')),
  width DECIMAL(10, 2),
  height DECIMAL(10, 2),
  depth DECIMAL(10, 2),
  weight DECIMAL(10, 2),
  media JSONB DEFAULT '[]'::JSONB, -- Array of ProductMedia
  mercado_livre_status TEXT,
  mercado_livre_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 9. Customers
CREATE TABLE public.customers (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  avatar_url TEXT,
  total_spent DECIMAL(10, 2) DEFAULT 0,
  join_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 10. Orders
CREATE TABLE public.orders (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,
  customer_name TEXT, -- Snapshot in case customer is deleted
  customer_email TEXT,
  shipping_address TEXT,
  status TEXT NOT NULL,
  origin TEXT,
  total DECIMAL(10, 2) NOT NULL,
  items JSONB NOT NULL, -- Snapshot of items
  events JSONB DEFAULT '[]'::JSONB,
  tracking_code TEXT,
  invoice_url TEXT,
  gateway_transaction_id TEXT,
  date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 11. Coupons
CREATE TABLE public.coupons (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  code TEXT NOT NULL,
  type TEXT NOT NULL,
  discount_type TEXT,
  discount_value DECIMAL(10, 2),
  min_purchase_value DECIMAL(10, 2),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 12. Reviews
CREATE TABLE public.reviews (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  order_id UUID REFERENCES public.orders(id) ON DELETE SET NULL,
  customer_name TEXT,
  customer_photo_url TEXT,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 13. Banners
CREATE TABLE public.banners (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  image_url TEXT NOT NULL,
  title TEXT,
  description TEXT,
  button_text TEXT,
  button_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 14. Chats
CREATE TABLE public.chats (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE NOT NULL,
  contact_name TEXT,
  contact_number TEXT NOT NULL,
  unread_count INTEGER DEFAULT 0,
  last_message TEXT,
  last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 15. Messages
CREATE TABLE public.messages (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  chat_id UUID REFERENCES public.chats(id) ON DELETE CASCADE NOT NULL,
  sender TEXT CHECK (sender IN ('admin', 'user')),
  text TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS Policies (Row Level Security)
-- Enable RLS on all tables
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.stores ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.brands ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.models ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.materials ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.colors ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.coupons ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.banners ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chats ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

-- Policies
-- Profiles: Users can see and edit their own profile
CREATE POLICY "Users can view own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- Stores: Users can access their own stores
CREATE POLICY "Users can view own stores" ON public.stores FOR SELECT USING (auth.uid() = owner_id);
CREATE POLICY "Users can insert own stores" ON public.stores FOR INSERT WITH CHECK (auth.uid() = owner_id);
CREATE POLICY "Users can update own stores" ON public.stores FOR UPDATE USING (auth.uid() = owner_id);
CREATE POLICY "Users can delete own stores" ON public.stores FOR DELETE USING (auth.uid() = owner_id);

-- Helper function to check store ownership
-- (Optimization: In a real app, you might join or use a claim, but strictly via SQL/RLS):
-- Generic policy for store-owned items:
-- auth.uid() must be the owner_id of the store referenced by store_id.

-- Categories
CREATE POLICY "Users can manage store categories" ON public.categories FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = categories.store_id AND stores.owner_id = auth.uid())
);

-- Brands
CREATE POLICY "Users can manage store brands" ON public.brands FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = brands.store_id AND stores.owner_id = auth.uid())
);

-- Models
CREATE POLICY "Users can manage store models" ON public.models FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = models.store_id AND stores.owner_id = auth.uid())
);

-- Materials
CREATE POLICY "Users can manage store materials" ON public.materials FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = materials.store_id AND stores.owner_id = auth.uid())
);

-- Colors
CREATE POLICY "Users can manage store colors" ON public.colors FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = colors.store_id AND stores.owner_id = auth.uid())
);

-- Products
CREATE POLICY "Users can manage store products" ON public.products FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = products.store_id AND stores.owner_id = auth.uid())
);

-- Customers
CREATE POLICY "Users can manage store customers" ON public.customers FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = customers.store_id AND stores.owner_id = auth.uid())
);

-- Orders
CREATE POLICY "Users can manage store orders" ON public.orders FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = orders.store_id AND stores.owner_id = auth.uid())
);

-- Coupons
CREATE POLICY "Users can manage store coupons" ON public.coupons FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = coupons.store_id AND stores.owner_id = auth.uid())
);

-- Reviews
CREATE POLICY "Users can manage store reviews" ON public.reviews FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = reviews.store_id AND stores.owner_id = auth.uid())
);

-- Banners
CREATE POLICY "Users can manage store banners" ON public.banners FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = banners.store_id AND stores.owner_id = auth.uid())
);

-- Chats
CREATE POLICY "Users can manage store chats" ON public.chats FOR ALL USING (
  EXISTS (SELECT 1 FROM public.stores WHERE stores.id = chats.store_id AND stores.owner_id = auth.uid())
);

-- Messages
CREATE POLICY "Users can manage chat messages" ON public.messages FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.chats 
    JOIN public.stores ON chats.store_id = stores.id 
    WHERE messages.chat_id = chats.id AND stores.owner_id = auth.uid()
  )
);

-- Trigger to create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, full_name, avatar_url)
  VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  
  -- Create a default store for the user with default settings
  INSERT INTO public.stores (owner_id, name, settings)
  VALUES (new.id, 'Minha Loja', '{
    "storeName": "Minha Loja",
    "domain": "",
    "address": { "street": "", "number": "", "complement": "", "neighborhood": "", "city": "", "state": "", "zipCode": "" },
    "branding": { 
      "logoUrl": "",
      "primaryColor": "#6366f1", 
      "secondaryColor": "#ec4899", 
      "accentColor": "#f59e0b",
      "backgroundColor": "#ffffff",
      "textColor": "#1f2937",
      "headerBackgroundColor": "#ffffff",
      "headerTextColor": "#111827",
      "footerBackgroundColor": "#111827",
      "footerTextColor": "#f3f4f6"
    },
    "banners": [],
    "infoPages": { "about": "", "howToBuy": "", "returns": "" },
    "email": { "smtpHost": "", "smtpPort": "", "smtpUser": "", "smtpPass": "", "purchaseConfirmationBody": "Ol√° {{cliente}},\\n\\nObrigado pela sua compra! Seu pedido #{{pedido_id}} foi confirmado." },
    "connectivity": { "whatsappPhone": "", "whatsappStatus": "Desconectado" },
    "socialMedia": { "facebook": "", "instagram": "", "tiktok": "", "youtube": "" },
    "integrations": { "mercadoPagoPublicKey": "", "mercadoPagoToken": "", "mercadoLivreUser": "", "mercadoLivreToken": "", "mercadoLivreStatus": "Desconectado" },
    "shipping": { "melhorEnvioToken": "", "additionalDays": 0, "additionalCost": 0, "freeShippingPolicy": { "enabled": false, "minValue": 0, "cities": "" } },
    "ai": { "googleAiToken": "", "assistantName": "Assistente", "restrictions": "", "trainingText": "" },
    "seo": { "googleAnalyticsId": "", "googleMerchantCenterId": "", "googleMyBusinessId": "", "facebookXmlUrl": "", "googleXmlUrl": "", "customHeadScript": "" }
  }'::JSONB);
  
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
